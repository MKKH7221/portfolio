<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.spring_project.infrastructure.datasource.UserMapper">

    <resultMap id="UserResultMap" type="com.example.spring_project.domain.model.user.User">
        <constructor>
            <arg name="id" column="id" javaType="Integer"/>
            <arg name="name" column="name" javaType="String"/>
            <arg name="address" column="address" javaType="String"/>
            <arg name="tel" column="tel" javaType="String"/>
            <arg name="country" resultMap="countryResultMap" javaType="com.example.spring_project.domain.model.country.Country"/>
        </constructor>
    </resultMap>
    <resultMap id="countryResultMap" type="com.example.spring_project.domain.model.country.Country">
        <constructor>
            <arg name="name" column="countryName" javaType="String"/>
            <arg name="code" column="countryCode" javaType="String"/>
        </constructor>
    </resultMap>
    <select id="findAll" resultMap="UserResultMap">
        SELECT 
            user.id, 
            user.name, 
            user.address, 
            user.tel, 
            country.name as countryName,
            country.code as countryCode
        FROM 
            user
        INNER JOIN country 
            ON user.country = country.code
    </select>

    <select id="findByCondition" resultMap="UserResultMap">
        SELECT 
            user.id, 
            user.name, 
            user.address, 
            user.tel, 
            country.name as countryName,
            country.code as countryCode
        FROM 
            user
        INNER JOIN country 
            ON user.country = country.code
         <where>
            <if test="id != null">
                user.id = #{id}
            </if>
            <if test="name != null">
                AND user.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="address != null">
                AND user.address LIKE CONCAT('%', #{address}, '%')
            </if>
            <if test="tel != null">
                AND user.tel LIKE CONCAT('%', #{tel}, '%')
            </if>
            <if test="countryCode != null">
                AND country.code = #{countryCode}
            </if>
        </where> 
    </select>
    <select id="findById" resultMap="UserResultMap">
        SELECT 
            user.id, 
            user.name, 
            user.address, 
            user.tel, 
            country.name as countryName,
            country.code as countryCode
        FROM 
            user
        INNER JOIN country 
            ON user.country = country.code
        WHERE id = #{id}
    </select>

    <update id="update">
        UPDATE 
            user 
        SET 
            name = #{name}, 
            address = #{address}, 
            tel = #{tel},
            country = #{country.code}
        WHERE 
            id = #{id}
    </update>
    <insert id="add">
        INSERT INTO user(
            name, 
            address, 
            tel, 
            country
        ) 
        VALUES (
            #{name},
            #{address}, 
            #{tel} ,
            #{countryCode}
        ) 
    </insert>
    <delete id="delete">
        DELETE FROM user WHERE id = #{id}
    </delete>
</mapper>
